using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using LinqQueryParser.Engine.Constants;
using LinqQueryParser.Engine.Helper;
using LinqQueryParser.Engine.Models;

namespace LinqQueryParser.Engine
{
	public class QueryEngineParser : IQueryParserEngine
	{
		public string ParseQuery(string query)
		{
			var commentedLines = GetCommentLines(query).Select(i => i.Trim('-', ' '));
			var variableList = commentedLines.Select(CreateVariable).Where(i => i != null).ToList();

			var declareLines = variableList.Select(CreateDeclareLine);
			var setLines = variableList.Select(CreateSetLine);

			var declareBlock = string.Join(Environment.NewLine, declareLines);
			var setBlock = string.Join(Environment.NewLine, setLines);

			var parsedQuery = $"{declareBlock}{Environment.NewLine}{setBlock}{Environment.NewLine}{query}";

			return parsedQuery;
		}

		public IEnumerable<string> GetCommentLines(string query)
		{
			return Regex.Split(query, Environment.NewLine).Where(i => i.Trim().StartsWith("--"));
		}

		private string CreateDeclareLine(Variable variable)
		{
			return (!string.IsNullOrEmpty(variable.Size) && variable.GetSizeValue() != "-1")
				? string.Format(LinqConstants.DECLARE_LINE_SIZE, variable.Name, variable.Type, variable.GetSizeValue())
				: string.Format(LinqConstants.DECLARE_LINE, variable.Name, variable.Type);
		}

		private string CreateSetLine(Variable variable)
		{
			return string.Format(LinqConstants.SET_LINE, variable.Name, variable.Value);
		}

		// @p0: Input Int (Size = -1; Prec = 0; Scale = 0) [1]
		private Variable CreateVariable(string line)
		{
			if (line.StartsWith(@"@"))
			{
				var name = Regex.Match(line, "(@.*?):").Value;
				var size = (Regex.Match(line, "Size = (.*?)[\\)\\;]").Value).Trim(';', ' ');
				var rawType = Regex.Match(line, "Input (.*?) ").Value;
				var type = rawType.GetTypeFromRawType();
				var value = Regex.Match(line, "\\[(.*?)\\]").Value.Trim('[', ']');

				return new Variable
				{
					Name = name.PurgeName(),
					Size = size,
					Type = type,
					RawType = rawType,
					Value = value.GetValueFromRawValue(type),
					Rawvalue = value
				};
			}

			return null;
		}
	}
}
